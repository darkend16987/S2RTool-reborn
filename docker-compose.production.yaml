# Production Docker Compose Configuration for S2RTool
# This file is optimized for deployment on target machines
#
# Usage:
#   docker-compose -f docker-compose.production.yaml up -d

services:
  # Backend service (Flask API)
  backend:
    # Use pre-built image from registry
    # Replace 'yourusername' with your Docker Hub username or registry URL
    image: ${DOCKER_REGISTRY:-docker.io}/${DOCKER_USERNAME:-yourusername}/s2rtool-backend:${VERSION:-latest}

    # Fallback to local build if image not available
    build:
      context: ./backend
      dockerfile: Dockerfile

    container_name: s2rtool-backend

    ports:
      - "${BACKEND_PORT:-5001}:5001"

    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - PORT=5001
      - HOST=0.0.0.0
      - PYTHONUNBUFFERED=1

    env_file:
      - .env

    volumes:
      # Only persist reference images (NO code mounting for production)
      - backend-references:/app/references

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - s2rtool-network

    # Resource limits (optional but recommended for production)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Frontend service (Nginx)
  frontend:
    # Use pre-built image from registry
    image: ${DOCKER_REGISTRY:-docker.io}/${DOCKER_USERNAME:-yourusername}/s2rtool-frontend:${VERSION:-latest}

    # Fallback to local build if image not available
    build:
      context: ./frontend
      dockerfile: Dockerfile

    container_name: s2rtool-frontend

    ports:
      - "${FRONTEND_PORT:-3001}:80"

    depends_on:
      backend:
        condition: service_healthy

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      - s2rtool-network

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

networks:
  s2rtool-network:
    driver: bridge

volumes:
  backend-references:
    driver: local
